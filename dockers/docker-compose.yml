version: "3"

services:

# HADOOP
  namenode:
    image: bde2020/hadoop-namenode:2.0.0-hadoop3.2.1-java8
    container_name: namenode
    restart: always
    ports:
      - 9870:9870
      - 9000:9000
    volumes:
      - hadoop_namenode:/hadoop/dfs/name
    environment:
      - CLUSTER_NAME=test
    env_file:
      - ./hadoop.env

  datanode:
    build:
      context: ./
      dockerfile: datanode/Dockerfile
    container_name: datanode
    restart: always
    ports:
      - 5000:5000
    volumes:
      - hadoop_datanode:/hadoop/dfs/data
      - ../images:/home
      - ./api:/app
    environment:
      SERVICE_PRECONDITION: "namenode:9870"
    env_file:
      - ./hadoop.env
  
  resourcemanager:
    image: bde2020/hadoop-resourcemanager:2.0.0-hadoop3.2.1-java8
    container_name: resourcemanager
    restart: always
    environment:
      SERVICE_PRECONDITION: "namenode:9000 namenode:9870 datanode:9864"
    env_file:
      - ./hadoop.env

  nodemanager1:
    image: bde2020/hadoop-nodemanager:2.0.0-hadoop3.2.1-java8
    container_name: nodemanager
    restart: always
    environment:
      SERVICE_PRECONDITION: "namenode:9000 namenode:9870 datanode:9864 resourcemanager:8088"
    env_file:
      - ./hadoop.env
  
  historyserver:
    image: bde2020/hadoop-historyserver:2.0.0-hadoop3.2.1-java8
    container_name: historyserver
    restart: always
    environment:
      SERVICE_PRECONDITION: "namenode:9000 namenode:9870 datanode:9864 resourcemanager:8088"
    volumes:
      - hadoop_historyserver:/hadoop/yarn/timeline
    env_file:
      - ./hadoop.env

# BASE DE DONNEES
  elasticsearch:
      image: elasticsearch:8.2.2
      environment:
        - discovery.type=single-node
        - ES_JAVA_OPTS=-Xms1g -Xmx1g
        - xpack.security.enabled=false
      volumes:
        - es_data:/usr/share/elasticsearch/data
      ports:
        - 9200:9200
  redis:
    image: redis:latest
    ports:
      - 6379:6379
    volumes:
      - redis_data:/data
    command: [ "redis-server"]
  
  mongodb:
    image: mongo
    container_name: mongodb
    hostname: mongodb
    restart: unless-stopped
    command: mongod --auth
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
      MONGO_INITDB_DATABASE: projetBDD
      MONGODB_DATA_DIR: /data/db
      MONGODB_LOG_DIR: /dev/null
    ports:
        - 27017:27017
    volumes:
      - mongo_db:/data/db
  
  # mongo-express:
  #   image: mongo-express
  #   restart: always
  #   ports:
  #     - 8081:8081
  #   environment:
  #     ME_CONFIG_MONGODB_ADMINUSERNAME: root
  #     ME_CONFIG_MONGODB_ADMINPASSWORD: root
  #     ME_CONFIG_MONGODB_URL: projetBDD
  #   depends_on:
  #     - mongodb

  # SCRIPTS
  python:
    container_name: python-twitter
    # command: python3 ../../stream.py
    build:
      dockerfile: python-twitter/Dockerfile
      context: ./
    volumes:
      - ./python-twitter:/usr/src
      - ./.env:/usr/src/.env
      - ../feeds:/usr/src/feeds/twitterClient.py
      - ../tools:/usr/src/tools
    
  python2:
    container_name: python-tmdb
    # command: python3 ../../stream.py
    build:
      dockerfile: python-tmdb/Dockerfile
      context: ./
    volumes:
      - ./python-tmdb:/usr/src
      - ./.env:/usr/src/.env
      - ../feeds:/usr/src/feeds/tmdbClient.py
      - ../tools:/usr/src/tools
    
  python3:
    container_name: python-RSS
    # command: python3 ../../stream.py
    build:
      dockerfile: python-RSS/Dockerfile
      context: ./
    volumes:
      - ./python-RSS:/usr/src
      - ./.env:/usr/src/.env
      - ../feeds:/usr/src/feeds/rssClient.py
      - ../tools:/usr/src/tools
    


  
volumes:
  hadoop_namenode:
  hadoop_datanode:
  hadoop_historyserver:
  es_data:
  mongo_db:
  redis_data:
